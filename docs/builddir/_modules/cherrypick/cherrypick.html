
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cherrypick.cherrypick &#8212; cherrypick 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cherrypick.cherrypick</h1><div class="highlight"><pre>
<span></span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Lucas Carames&quot;</span>
<span class="n">__license__</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span>
<span class="n">__version__</span><span class="o">=</span><span class="s1">&#39;0.1.0&#39;</span>
<span class="n">__maintainer__</span><span class="o">=</span><span class="s1">&#39;Lucas Carames&#39;</span>
<span class="n">__email__</span><span class="o">=</span><span class="s1">&#39;lgpcarames@gmail.com&#39;</span>


<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>
<span class="kn">import</span> <span class="nn">optuna</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>


<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">mutual_info_classif</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>

<span class="kn">import</span> <span class="nn">shap</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="c1"># Categorical features process</span>
<span class="k">class</span> <span class="nc">CatEncoder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similarly to SKLearn LabelEncoder, but it does work with new categories.</span>

<span class="sd">    To be use:</span>
<span class="sd">    ----------</span>
<span class="sd">    ce = CatEncoder()</span>
<span class="sd">    ce.fit(dataframe[selected_columns])</span>

<span class="sd">    ce.transform(dataframe[selected_columns])</span>
<span class="sd">    </span>

<span class="sd">    Developed by: Vin√≠cius Ormenesse - https://github.com/ormenesse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rev_dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vet</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;CatEncoder&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the encoder for the data passed in the &#39;vet&#39; variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uniques</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">vet</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uniques</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rev_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vet</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the type of the &#39;vet&#39; variable and converts it to a pd.Series if it is a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vet</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vet</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vet</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms the label according to the adaptation made by the encoder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">vet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vet</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inverse_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vet</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverses the transformation performed by the encoder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">vet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vet</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rev_dic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vet</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adapts the encoder to the data and then transforms it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">vet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">vet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">vet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
    

<span class="k">class</span> <span class="nc">SearchHyperParams</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregates the functions to be used in the study of optimal hyperparameters of the models</span>
<span class="sd">    that will be used in the variable selection step.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cross_val</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgbm_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_tree_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_val</span> <span class="o">=</span> <span class="n">cross_val</span>

    <span class="k">def</span> <span class="nf">objective_lr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">var_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                     <span class="n">var_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tol&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;tol&quot;</span><span class="p">,</span> <span class="mf">0.000001</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s2">&quot;max_iter&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;max_iter&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
            <span class="s2">&quot;l1_ratio&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;l1_ratio&quot;</span><span class="p">,</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">cv_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cv_scores_train</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_val</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">var_train</span><span class="p">,</span> <span class="n">var_test</span><span class="p">):</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">var_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">var_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
            <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">var_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">var_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;elasticnet&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span>
                                       <span class="n">random_state</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="o">**</span><span class="n">param_grid</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">cv_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">cv_scores_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">cv_scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">cv_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">cv_scores_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_scores_train</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">objective_decision_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">var_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                                <span class="n">var_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;criterion&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">&quot;criterion&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]),</span>
            <span class="s2">&quot;splitter&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">&quot;splitter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;best&#39;</span><span class="p">]),</span>
            <span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
            <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;min_samples_split&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
            <span class="s1">&#39;max_leaf_nodes&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_leaf_nodes&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
            <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;ccp_alpha&#39;</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">cv_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cv_scores_train</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_val</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">var_train</span><span class="p">,</span> <span class="n">var_test</span><span class="p">):</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">var_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">var_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
            <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">var_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">var_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">param_grid</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="n">cv_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="n">cv_scores_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">cv_scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_scores_train</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">objective_lgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">var_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                      <span class="n">var_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;n_estimators&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="s2">&quot;num_leaves&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">&quot;num_leaves&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">]),</span>
            <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">&quot;max_depth&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
            <span class="s2">&quot;reg_alpha&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;lambda_l1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;reg_lambda&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;lambda_l2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;colsample_bytree&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;colsample_bytree&quot;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">cv_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cv_scores_train</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_val</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">var_train</span><span class="p">,</span> <span class="n">var_test</span><span class="p">):</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">var_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">var_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
            <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">var_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">var_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">param_grid</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)],</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">&quot;auc&quot;</span><span class="p">,</span>
                      <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="n">cv_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="n">cv_scores_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">cv_scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_scores_train</span><span class="p">)</span>


<div class="viewcode-block" id="CherryPick"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick">[docs]</a><span class="k">class</span> <span class="nc">CherryPick</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CherryPick class for feature importance analysis and scoring.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    data: pd.DataFrame</span>
<span class="sd">        Input dataframe containing the data.</span>

<span class="sd">    variables: list</span>
<span class="sd">        List of variable names.</span>

<span class="sd">    target: str</span>
<span class="sd">        Target variable name.</span>

<span class="sd">    lgbModel: object, optional</span>
<span class="sd">        Trained LightGBM model.</span>

<span class="sd">    treeModel: object, optional</span>
<span class="sd">        Trained Decision Tree model.</span>

<span class="sd">    data_most_important: pd.DataFrame, optional</span>
<span class="sd">        Cached dataframe containing the most important features.</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    gera_shap_score(data, variables, target):</span>
<span class="sd">        Generate SHAP scores for feature importance.</span>

<span class="sd">    _run_lgbm(data, variables, target):</span>
<span class="sd">        Run LightGBM model for feature importance.</span>

<span class="sd">    run_tree(data, variables, target):</span>
<span class="sd">        Run Decision Tree model for feature importance.</span>

<span class="sd">    data_shap_score():</span>
<span class="sd">        Classify feature importance according to SHAP scores.</span>

<span class="sd">    data_lgbm_gain():</span>
<span class="sd">        Classify feature importance according to gain of entropy in a LightGBM model.</span>

<span class="sd">    data_lgbm_split():</span>
<span class="sd">        Classify feature importance according to split of entropy in a LightGBM model.</span>

<span class="sd">    data_logistic_roc():</span>
<span class="sd">        Classify feature importance according to the ROC of a logistic model.</span>

<span class="sd">    data_mutual_info():</span>
<span class="sd">        Classify feature importance according to mutual information.</span>

<span class="sd">    data_tree_gain():</span>
<span class="sd">        Classify feature importance according to gain of entropy in a Decision Tree model.</span>

<span class="sd">    get_feature_importances(logistic_roc=True, mutual_info=True, shap_score=True,</span>
<span class="sd">                            tree_gain=True, boost_gain=True, boost_split=True, cache=True):</span>
<span class="sd">        Generate a table compiling the results of each metric for feature importance.</span>

<span class="sd">    __standard_score__(df, metrics_column):</span>
<span class="sd">        Calculate the standard score for ranking metrics.</span>

<span class="sd">    __cluster_score__(df, metrics_column, n_cluster=8, init=&#39;k-means++&#39;, n_init=10,</span>
<span class="sd">                      tol=1e-4, verbose=0, random_state=13, algorithm=&#39;lloyd&#39;):</span>
<span class="sd">        Calculate the cluster score for ranking metrics.</span>

<span class="sd">    calculate_score(df, metrics_column, strategy=&#39;standard&#39;):</span>
<span class="sd">        Calculate the score for ranking metrics based on the specified strategy.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">study_cross_val</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">num_studies</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">overfit_thres</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">log_lr_study</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">log_lgb_study</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">log_tree_study</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">baseline</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">baseline</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please check the type of the variable. It must be a string.&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># Inserting a column with a random variable for comparison</span>
        <span class="k">if</span> <span class="s1">&#39;random_variable&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;random_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">study_cross_val</span> <span class="o">=</span> <span class="n">study_cross_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_studies</span> <span class="o">=</span> <span class="n">num_studies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overfit_thres</span> <span class="o">=</span> <span class="n">overfit_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_lr_study</span> <span class="o">=</span> <span class="n">log_lr_study</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_log_lr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_lgb_study</span> <span class="o">=</span> <span class="n">log_lgb_study</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_log_lgb</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_tree_study</span> <span class="o">=</span> <span class="n">log_tree_study</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_log_tree</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Output data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_most_important</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Loading models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrModel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treeModel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummyModel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Loading the objective function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchParams</span> <span class="o">=</span> <span class="n">SearchHyperParams</span><span class="p">(</span><span class="n">cross_val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study_cross_val</span><span class="p">)</span>

        <span class="c1"># Redefining the feature names in the inserted data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">__set_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">baseline</span><span class="p">):</span>
        <span class="c1"># Input data</span>
        <span class="n">temp_var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">baseline</span><span class="p">:</span>
            <span class="n">temp_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_var</span><span class="p">,</span> <span class="s1">&#39;random_variable&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp_var</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp_var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">temp_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">temp_var</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp_var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">temp_var</span> <span class="o">=</span> <span class="n">temp_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please check the type of the variable. It must be either a string or a list.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp_var</span>
<div class="viewcode-block" id="CherryPick.mutual_info"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.mutual_info">[docs]</a>    <span class="k">def</span> <span class="nf">mutual_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">explicable_vars</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the mutual info between the explicable and target variables.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        data: pd.DataFrame</span>
<span class="sd">            DataFrame that will be used to choose the most important features</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">explicable_vars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">df_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">explicable_vars</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[[</span><span class="n">explicable_vars</span><span class="p">,</span> <span class="n">target</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">explicable_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">df_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">explicable_vars</span> <span class="o">+</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">explicable_vars</span> <span class="o">+</span> <span class="p">[</span><span class="n">target</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mutual_info_classif</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">]),</span> <span class="n">df_</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span></div>

<div class="viewcode-block" id="CherryPick.logistic_roc"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.logistic_roc">[docs]</a>    <span class="k">def</span> <span class="nf">logistic_roc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">explicable_vars</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to obtain the ROC of a logistic regression model trained</span>
<span class="sd">        on a specified set of variables.</span>
<span class="sd">        The model is optimized using optuna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">explicable_vars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">df_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[[</span><span class="n">explicable_vars</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">target</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">explicable_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">df_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">explicable_vars</span> <span class="o">+</span> <span class="p">[</span><span class="n">target</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Variables must be an instance of list or str&quot;</span><span class="p">)</span>

        <span class="n">df_</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">directions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="s1">&#39;minimize&#39;</span><span class="p">])</span>
            <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">trial</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchParams</span><span class="o">.</span><span class="n">objective_lr</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">df_</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">df_</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
            <span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
            <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_studies</span><span class="p">)</span>

            <span class="n">gdsOptuna</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">trials_dataframe</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_lr_study</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_log_lr</span> <span class="o">=</span> <span class="n">gdsOptuna</span><span class="p">[(</span><span class="n">gdsOptuna</span><span class="p">[</span><span class="s1">&#39;values_1&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">overfit_thres</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;values_0&#39;</span><span class="p">,</span> <span class="s1">&#39;values_1&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">dicts</span> <span class="o">=</span> <span class="n">gdsOptuna</span><span class="p">[(</span><span class="n">gdsOptuna</span><span class="p">[</span><span class="s1">&#39;values_1&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">overfit_thres</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;values_0&#39;</span><span class="p">,</span> <span class="s1">&#39;values_1&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;values_0&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>
<div class="viewcode-block" id="CherryPick.run_tree"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.run_tree">[docs]</a>    <span class="k">def</span> <span class="nf">run_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">colunas</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">alvo</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DecisionTreeClassifier</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the decision tree model with the best hyperparameters found through Optuna.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe : pd.DataFrame</span>
<span class="sd">            DataFrame containing the data.</span>
<span class="sd">        colunas : list</span>
<span class="sd">            List of column names used as features.</span>
<span class="sd">        alvo : str</span>
<span class="sd">            Target variable name.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        DecisionTreeClassifier</span>
<span class="sd">            Trained decision tree model with the best hyperparameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">directions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="s1">&#39;minimize&#39;</span><span class="p">])</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">trial</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchParams</span><span class="o">.</span><span class="n">objective_decision_tree</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">],</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">alvo</span><span class="p">])</span>

        <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_studies</span><span class="p">)</span>

        <span class="n">gdsOptuna</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">trials_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_tree_study</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_log_tree</span> <span class="o">=</span> <span class="n">gdsOptuna</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;values_0&#39;</span><span class="p">,</span> <span class="s1">&#39;values_1&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">dicts</span> <span class="o">=</span> <span class="n">gdsOptuna</span><span class="p">[(</span><span class="n">gdsOptuna</span><span class="p">[</span><span class="s1">&#39;values_1&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">overfit_thres</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;values_0&#39;</span><span class="p">,</span> <span class="s1">&#39;values_1&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;criterion&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_criterion&#39;</span><span class="p">],</span>
            <span class="s1">&#39;splitter&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_splitter&#39;</span><span class="p">],</span>
            <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_min_samples_leaf&#39;</span><span class="p">],</span>
            <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_min_samples_split&#39;</span><span class="p">],</span>
            <span class="s1">&#39;max_leaf_nodes&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_max_leaf_nodes&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_ccp_alpha&#39;</span><span class="p">],</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_max_depth&#39;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">treeModel</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treeModel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">],</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">alvo</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">treeModel</span></div>

    <span class="k">def</span> <span class="nf">_run_lgbm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">colunas</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">alvo</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the LightGBM model with the best hyperparameters found through Optuna.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe : pd.DataFrame</span>
<span class="sd">            DataFrame containing the data.</span>
<span class="sd">        colunas : list</span>
<span class="sd">            List of column names used as features.</span>
<span class="sd">        alvo : str</span>
<span class="sd">            Target variable name.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        lgb.LGBMClassifier</span>
<span class="sd">            Trained LightGBM model with the best hyperparameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">directions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="s1">&#39;minimize&#39;</span><span class="p">])</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">trial</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchParams</span><span class="o">.</span><span class="n">objective_lgb</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">],</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">alvo</span><span class="p">])</span>

        <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_studies</span><span class="p">)</span>

        <span class="n">gdsOptuna</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">trials_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_lgb_study</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_log_lgb</span> <span class="o">=</span> <span class="n">gdsOptuna</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;values_0&#39;</span><span class="p">,</span> <span class="s1">&#39;values_1&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">dicts</span> <span class="o">=</span> <span class="n">gdsOptuna</span><span class="p">[(</span><span class="n">gdsOptuna</span><span class="p">[</span><span class="s1">&#39;values_1&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">overfit_thres</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;values_0&#39;</span><span class="p">,</span> <span class="s1">&#39;values_1&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_colsample_bytree&#39;</span><span class="p">],</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_learning_rate&#39;</span><span class="p">],</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_max_depth&#39;</span><span class="p">],</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_n_estimators&#39;</span><span class="p">],</span>
            <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_num_leaves&#39;</span><span class="p">],</span>
            <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_lambda_l1&#39;</span><span class="p">],</span>
            <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="n">dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params_lambda_l2&#39;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">],</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">alvo</span><span class="p">],</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">&quot;auc&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span>
    



<div class="viewcode-block" id="CherryPick.gera_shap_score"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.gera_shap_score">[docs]</a>    <span class="k">def</span> <span class="nf">gera_shap_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">colunas</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">alvo</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates SHAP scores and feature importance using LightGBM model.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe : pd.DataFrame</span>
<span class="sd">            DataFrame containing the data.</span>
<span class="sd">        colunas : Union[str, list]</span>
<span class="sd">            Column names used as features.</span>
<span class="sd">        alvo : str</span>
<span class="sd">            Target variable name.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        List</span>
<span class="sd">            List containing the SHAP scores DataFrame and the SHAP values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span>
            <span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">light_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_lgbm</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">colunas</span><span class="p">,</span> <span class="n">alvo</span><span class="p">)</span>

            <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">Explainer</span><span class="p">(</span><span class="n">light_model</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">])</span>
            <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">])</span>

            <span class="n">arr_order</span> <span class="o">=</span> <span class="n">shap_values</span><span class="o">.</span><span class="n">abs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

            <span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="n">shap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shap_values</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)[</span><span class="n">arr_order</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shap_values</span><span class="o">.</span><span class="n">abs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="n">arr_order</span><span class="p">])),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;shap_score&#39;</span><span class="p">])</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">shap_df</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_lgbm</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">colunas</span><span class="p">,</span> <span class="n">alvo</span><span class="p">)</span>

        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">Explainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">])</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">colunas</span><span class="p">])</span>

        <span class="n">arr_order</span> <span class="o">=</span> <span class="n">shap_values</span><span class="o">.</span><span class="n">abs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

        <span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="n">shap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shap_values</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)[</span><span class="n">arr_order</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shap_values</span><span class="o">.</span><span class="n">abs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="n">arr_order</span><span class="p">])),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;shap_score&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">shap_df</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">]</span></div>


<div class="viewcode-block" id="CherryPick.data_shap_score"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.data_shap_score">[docs]</a>    <span class="k">def</span> <span class="nf">data_shap_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify the feature importance according to the SHAP score metric.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;shap_score_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- STARTING SHAP SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gera_shap_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shap_score&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- FINISHED SHAP SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aux</span></div>

<div class="viewcode-block" id="CherryPick.data_lgbm_gain"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.data_lgbm_gain">[docs]</a>    <span class="k">def</span> <span class="nf">data_lgbm_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify the feature importance according to the gain of entropy in a boost model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- STARTING BOOST GAIN SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_lgbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;lightGBM_gain_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- FINISHED BOOST GAIN SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="o">.</span><span class="n">feature_name_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="o">.</span><span class="n">booster_</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">))),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CherryPick.data_lgbm_split"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.data_lgbm_split">[docs]</a>    <span class="k">def</span> <span class="nf">data_lgbm_split</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify the feature importance according to the split of entropy in a boost model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- STARTING BOOST SPLIT SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_lgbm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;lightGBM_split_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- FINISHED BOOST SPLIT SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="o">.</span><span class="n">feature_name_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgbModel</span><span class="o">.</span><span class="n">booster_</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">))),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CherryPick.data_logistic_roc"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.data_logistic_roc">[docs]</a>    <span class="k">def</span> <span class="nf">data_logistic_roc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify the feature importance according to the ROC of a logistic model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- STARTING LOGISTIC ROC SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;logistic_roc_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="n">dic_</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="n">metric</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;logistic-roc metric&#39;</span><span class="p">):</span>
            <span class="n">dic_</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
            <span class="n">dic_</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logistic_roc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- FINISHED LOGISTIC ROC SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dic_</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CherryPick.data_mutual_info"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.data_mutual_info">[docs]</a>    <span class="k">def</span> <span class="nf">data_mutual_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify the feature importance according to the mutual information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- STARTING MUTUAL INFORMATION SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;mutual_info_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="n">dic_</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="n">metric</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;mutual information metric&#39;</span><span class="p">):</span>
            <span class="n">dic_</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
            <span class="n">dic_</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mutual_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- FINISHED MUTUAL INFORMATION SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dic_</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">data_tree_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- STARTING DECISION TREE GAIN SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">treeModel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;decisionTree_gain_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- FINISHED DECISION TREE GAIN SCORING FOR TARGET: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">treeModel</span><span class="o">.</span><span class="n">feature_names_in_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">treeModel</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="CherryPick.get_feature_importances"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.get_feature_importances">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature_importances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logistic_roc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mutual_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shap_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">tree_gain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boost_gain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boost_split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a table compiling the results of each metric for feature importance.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        logistic_roc: bool, optional (default: True)</span>
<span class="sd">            If True, include logistic ROC metric in the feature selection pipeline.</span>

<span class="sd">        mutual_info: bool, optional (default: True)</span>
<span class="sd">            If True, include mutual information metric in the feature selection pipeline.</span>

<span class="sd">        shap_score: bool, optional (default: True)</span>
<span class="sd">            If True, include SHAP score metric in the feature selection pipeline.</span>

<span class="sd">        tree_gain: bool, optional (default: True)</span>
<span class="sd">            If True, include tree gain metric in the feature selection pipeline.</span>

<span class="sd">        boost_gain: bool, optional (default: True)</span>
<span class="sd">            If True, include LGBM gain metric in the feature selection pipeline.</span>

<span class="sd">        boost_split: bool, optional (default: True)</span>
<span class="sd">            If True, include LGBM split metric in the feature selection pipeline.</span>

<span class="sd">        cache: bool, optional (default: True)</span>
<span class="sd">            If True, cache the results for future use.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A dataframe containing the compiled feature importances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_most_important</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_most_important</span>

        <span class="n">temp_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">logistic_roc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_logistic_roc</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mutual_info</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_mutual_info</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tree_gain</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tree_gain</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shap_score</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shap_score</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">boost_gain</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_lgbm_gain</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">boost_split</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_lgbm_split</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_most_important</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">),</span> <span class="n">temp_</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Something went wrong!&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_most_important</span></div>

    <span class="k">def</span> <span class="nf">__standard_score__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">metrics_column</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the standard score for ranking metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metrics_column</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;standard_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">df_</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;temp_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;standard_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[[</span><span class="s1">&#39;standard_score&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_score&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">df_</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;temp_score&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;standard_score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__cluster_score__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">metrics_column</span><span class="p">,</span> <span class="n">n_cluster</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">13</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the cluster score for ranking metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metrics_column</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metrics_column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
            <span class="n">df_scaled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_</span><span class="p">[[</span><span class="n">col</span><span class="p">]])</span>

        <span class="n">cluster</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span>
                        <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
                        <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span>
                        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
                        <span class="p">)</span>
        <span class="n">cluster</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">[</span><span class="n">metrics_column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>

        <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">[</span><span class="n">metrics_column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;cluster_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_scaled</span><span class="p">[</span><span class="n">metrics_column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;cluster_score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="CherryPick.competitive_score"><a class="viewcode-back" href="../../api.html#cherrypick.CherryPick.competitive_score">[docs]</a>    <span class="k">def</span> <span class="nf">competitive_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">metrics_column</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the dataframe, and the columns with the metrics. Calculates the score by ranking the metrics.</span>
<span class="sd">        The first column of the dataframe must be the variables column. All others must be numeric.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        df: pd.DataFrame</span>
<span class="sd">            Dataframe containing the metrics.</span>


<span class="sd">        metrics_column: list</span>
<span class="sd">            List of columns containing the metrics.</span>

<span class="sd">        strategy: str, optional (default: &#39;standard&#39;)</span>
<span class="sd">            The scoring strategy to use. Can be &#39;standard&#39; or &#39;cluster&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Dataframe sorted by the calculated score.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__standard_score__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">metrics_column</span><span class="o">=</span><span class="n">metrics_column</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;cluster&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cluster_score__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">metrics_column</span><span class="o">=</span><span class="n">metrics_column</span><span class="p">)</span></div></div>




<span class="k">def</span> <span class="nf">threshold_score</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the optimal classification threshold based on predicted probabilities and target values.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    predictions : Union[list, np.ndarray]</span>
<span class="sd">        Iterable with predicted probabilities from the target variable.</span>

<span class="sd">    target : Union[list, np.ndarray]</span>
<span class="sd">        Iterable with the actual information from the target variable.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    threshold_score : dict</span>
<span class="sd">        Dictionary with information on the optimal threshold and ranking metrics such as precision, recall,</span>
<span class="sd">        accuracy, ROC-AUC, and F1-score.</span>

<span class="sd">    Developed by: Vin√≠cius Ormenesse - https://github.com/ormenesse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tpr</span><span class="p">))</span>
    <span class="n">roc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;tf&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tpr</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fpr</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">),</span> <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">)})</span>
    <span class="n">roc_t</span> <span class="o">=</span> <span class="n">roc</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">roc</span><span class="o">.</span><span class="n">tf</span><span class="o">-</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">roc_t</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">tp</span><span class="p">)</span>
    <span class="n">f_score</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;f-score&#39;</span><span class="p">:</span> <span class="n">f_score</span><span class="p">,</span>
        <span class="s1">&#39;roc-auc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">predictions</span><span class="p">),</span>
        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">roc_t</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">])</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">__get_features_threshold_score__</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain the optimal threshold classification for each specified variable.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Dataframe that contains the data for the explanatory variable and the target variable.</span>

<span class="sd">    variables : Union[list, np.ndarray]</span>
<span class="sd">        List with the names of the explanatory variables for which the optimal classification</span>
<span class="sd">        threshold is to be obtained.</span>

<span class="sd">    target : str</span>
<span class="sd">        Name of the target variable.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    __get_features_threshold_score__ : pd.DataFrame</span>
<span class="sd">        Dataframe containing, for each explanatory variable, its normalized and non-normalized threshold.</span>
<span class="sd">        The threshold specifies from which value we can classify the target variable to optimize specificity</span>
<span class="sd">        and sensitivity.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">target</span><span class="p">]]</span>

    <span class="n">array_thres</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">variable</span><span class="p">]])</span>
        <span class="n">temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">limiar_temp</span> <span class="o">=</span> <span class="n">threshold_score</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
        <span class="n">limiar_temp</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="n">variable</span><span class="p">})</span>
        <span class="n">limiar_temp</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;threshold_variable&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">([[</span><span class="n">limiar_temp</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]]])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>

        <span class="n">array_thres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">limiar_temp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">array_thres</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__best_threshold_classification__</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform the prediction of the target variable based on each of its explanatory variables.</span>
<span class="sd">    The classification is carried out separately for each explanatory variable, using only their</span>
<span class="sd">    respective optimal threshold values. The threshold values are sorted based on the highest</span>
<span class="sd">    roc rating.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Dataframe that contains the data for the explanatory variables and the target variable.</span>

<span class="sd">    variables : Union[list, np.ndarray]</span>
<span class="sd">        List with the names of the explanatory variables.</span>

<span class="sd">    target : str</span>
<span class="sd">        Name of the target variable.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    __best_threshold_classification__ : pd.DataFrame</span>
<span class="sd">        A dataframe where each column represents the classification based on the optimal threshold</span>
<span class="sd">        for each variable.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_</span> <span class="o">=</span> <span class="n">__get_features_threshold_score__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">temp_thres</span> <span class="o">=</span> <span class="n">temp_</span><span class="p">[</span><span class="n">temp_</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">variable</span><span class="p">][</span><span class="s1">&#39;threshold_variable&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Classify based on the optimal threshold to maximize roc-auc</span>
        <span class="n">temp_list_geq_thres</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">temp_thres</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">score_geq_thres</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">temp_list_geq_thres</span><span class="p">)</span>

        <span class="n">temp_list_leq_thres</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">temp_thres</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">score_leq_thres</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">temp_list_leq_thres</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">score_geq_thres</span> <span class="o">&gt;=</span> <span class="n">score_leq_thres</span><span class="p">:</span>
            <span class="n">df_temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_list_geq_thres</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_list_leq_thres</span>

    <span class="k">return</span> <span class="n">df_temp</span>


<span class="k">def</span> <span class="nf">__set_difficulty_group__</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the difficulty groups for classifying the rows based on the accuracy rate of the explanatory variables.</span>
<span class="sd">    Rows with an accuracy rate higher than the average will be classified as easy, while rows with an accuracy rate</span>
<span class="sd">    lower than the average will be classified as difficult.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Dataframe that contains the data for the explanatory variables and the target variable.</span>

<span class="sd">    target : str</span>
<span class="sd">        Name of the target variable.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    __set_difficulty_group__ : pd.DataFrame</span>
<span class="sd">        Dataframe with an additional column indicating the difficulty group of each row.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    Exception</span>
<span class="sd">        If the target variable is not binary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">success_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rate_0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">rate_0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rate_1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">rate_1</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">success_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate_0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">success_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate_1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Target variable must be binary class.&#39;</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">success_list</span>

    <span class="n">difficulty_threshold</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Set the difficulty group: 0 for easy lines, 1 for difficult lines</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">difficulty_threshold</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>



<span class="k">def</span> <span class="nf">__generate_stats_sucess__</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">variables</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">g0_weight</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="n">g1_weight</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the cherry score along with the statistics used to calculate it.</span>
<span class="sd">    The statistics include the success rate range of each variable between the groups of greater and lesser difficulty</span>
<span class="sd">    in classification, quartile of the variable in relation to the groups, and the cherry score.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Dataframe that contains data referring to the explanatory variable and the target variable.</span>

<span class="sd">    variables : Union[list, np.ndarray]</span>
<span class="sd">        Iterable with the variables for which the cherry score is to be calculated.</span>

<span class="sd">    target : str</span>
<span class="sd">        Name of the target variable.</span>

<span class="sd">    g0_weight : list</span>
<span class="sd">        Weight given according to the hit rate of a variable in the group of easiest lines.</span>
<span class="sd">        The weight is associated with the quartile that the variable assumes in the group.</span>
<span class="sd">        The lower the quartile, the fewer number of hits the variable had in the group,</span>
<span class="sd">        therefore, the weight will be lower.</span>

<span class="sd">    g1_weight : list</span>
<span class="sd">        Weight given according to the hit rate of a variable in the group of the most difficult lines.</span>
<span class="sd">        The weight is associated with the quartile that the variable assumes in the group.</span>
<span class="sd">        The lower the quartile, the fewer number of hits the variable had in the group,</span>
<span class="sd">        therefore, the weight will be lower.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    __generate_stats_sucess__ : pd.DataFrame</span>
<span class="sd">        Dataframe with the cherry score, along with the statistical metrics used for its calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;success_rate_g0&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;success_rate_g1&#39;</span><span class="p">:</span> <span class="p">[]})</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">check_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;rightClassification&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;difficulty_group&#39;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">]:</span>
                <span class="n">check_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">check_list</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rightClassification&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;difficulty_group&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">check_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">check_list</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rightClassification&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;difficulty_group&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">check_list</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rightClassification&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;difficulty_group&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]}</span>

        <span class="n">success_rate_g0</span> <span class="o">=</span> <span class="n">check_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">check_list</span><span class="p">[</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;rightClassification&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">check_list</span><span class="p">[</span><span class="n">check_list</span><span class="p">[</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">success_rate_g1</span> <span class="o">=</span> <span class="n">check_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">check_list</span><span class="p">[</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rightClassification&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">check_list</span><span class="p">[</span><span class="n">check_list</span><span class="p">[</span><span class="s1">&#39;difficulty_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span> <span class="s1">&#39;success_rate_g0&#39;</span><span class="p">:</span> <span class="n">success_rate_g0</span><span class="p">,</span> <span class="s1">&#39;success_rate_g1&#39;</span><span class="p">:</span> <span class="n">success_rate_g1</span><span class="p">}</span>

    <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;g0_quantile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;success_rate_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;Q1&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;success_rate_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.33</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;Q2&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;success_rate_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.66</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Q3&#39;</span><span class="p">))</span>
    <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;g1_quantile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;success_rate_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;Q1&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;success_rate_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.33</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;Q2&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;success_rate_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.66</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Q3&#39;</span><span class="p">))</span>

    <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;g0_quantile_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;g0_quantile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">g0_weight</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Q3&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="n">g0_weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Q2&#39;</span> <span class="k">else</span> <span class="n">g0_weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;g1_quantile_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;g1_quantile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">g1_weight</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Q3&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="n">g1_weight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Q2&#39;</span> <span class="k">else</span> <span class="n">g1_weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">df_</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cherry_score</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;g0_quantile_score&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;success_rate_g0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;g1_quantile_score&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;success_rate_g1&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;cherry_score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>



<div class="viewcode-block" id="cherry_score"><a class="viewcode-back" href="../../api.html#cherrypick.cherry_score">[docs]</a><span class="k">def</span>  <span class="nf">cherry_score</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">only_score</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that sets the pipeline to properly calculate the cherry score.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    df: pd.DataFrame</span>
<span class="sd">    Dataframe that contains data referring to the explanatory variable and the target variable.</span>

<span class="sd">    variables: Union[list, np.ndarray]</span>
<span class="sd">    Iterable with the variables you want to calculate the cherry score</span>

<span class="sd">    target: str</span>
<span class="sd">    Target variable name</span>

<span class="sd">    only_score: bool</span>
<span class="sd">    if True, returns a dataframe with features names and cherry_score, if False, also returns all the</span>
<span class="sd">    statiscal features that are used to obtain the cherry_score.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    generate_cherry_score: pd.DataFrame</span>
<span class="sd">    Dataframe with the cherry score or the entire dataframe with cherry score statistics,</span>
<span class="sd">    depending on the value of `only_score`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s1">&#39;TypeError: variables must not be a string type variable&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">iter</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;variables must be an iterable&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">classified_df</span> <span class="o">=</span> <span class="n">__best_threshold_classification__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

        <span class="n">df_difficulty</span> <span class="o">=</span> <span class="n">__set_difficulty_group__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">classified_df</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">,</span> <span class="s1">&#39;cherry_score&#39;</span><span class="p">:</span> <span class="n">df_difficulty</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">df_difficulty</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>


    <span class="n">classified_df</span> <span class="o">=</span> <span class="n">__best_threshold_classification__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

    <span class="c1"># Creating a column with difficulty group</span>
    <span class="n">df_difficulty</span> <span class="o">=</span> <span class="n">__set_difficulty_group__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">classified_df</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

    <span class="n">df_score</span> <span class="o">=</span> <span class="n">__generate_stats_sucess__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_difficulty</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">only_score</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_score</span><span class="p">[[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;cherry_score&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_score</span>
      
   


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">cherrypick</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">cherrypick</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Lucas Carames.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>